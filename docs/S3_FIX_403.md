# Fixing S3 403 Forbidden Errors

## Problem
Images are returning `403 Forbidden` when trying to access S3 URLs. This means the bucket permissions are not correctly configured.

## Solution Checklist

### Step 1: Verify Block Public Access is OFF

1. Go to S3 Console → `nealy-decor-bucket` → **Permissions** tab
2. Find **"Block public access (bucket settings)"**
3. Click **Edit**
4. **UNCHECK** all 4 boxes:
   - ☐ Block all public access
   - ☐ Block public access to buckets and objects granted through new access control lists (ACLs)
   - ☐ Block public access to buckets and objects granted through any access control lists (ACLs)
   - ☐ Block public access to buckets and objects granted through new public bucket or access point policies
   - ☐ Block public and cross-account access to buckets and objects through any public bucket or access point policies
5. Click **Save changes**
6. Type `confirm` when prompted

### Step 2: Verify Bucket Policy

1. Still in **Permissions** tab → Scroll to **Bucket policy**
2. Click **Edit**
3. Make sure this exact policy is present (replace `nealy-decor-bucket` if different):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::nealy-decor-bucket/*"
    }
  ]
}
```

4. Click **Save changes**

**Important**: The ARN must match your bucket name exactly. Check the **Properties** tab to see your exact ARN.

### Step 3: Add CORS Configuration

1. Still in **Permissions** tab → Scroll to **Cross-origin resource sharing (CORS)**
2. Click **Edit**
3. Paste the configuration from `S3_CORS_CONFIG.json`:

```json
[
  {
    "AllowedHeaders": [
      "*"
    ],
    "AllowedMethods": [
      "GET",
      "HEAD"
    ],
    "AllowedOrigins": [
      "http://localhost:3000",
      "http://localhost:3001",
      "https://nealyevents.com",
      "https://www.nealyevents.com",
      "https://*.vercel.app",
      "https://*.netlify.app"
    ],
    "ExposeHeaders": [
      "ETag",
      "Content-Length",
      "Content-Type"
    ],
    "MaxAgeSeconds": 3000
  }
]
```

4. Click **Save changes**

### Step 4: Verify Object-Level Permissions (if needed)

If files still don't load after the above steps:

1. Go to **Objects** tab
2. Select a file (e.g., `01-Website-Creation/03 Gallery/BlueSofaLounge/IMG_0936.jpg`)
3. Click **Actions** → **Make public using ACL** (if this option appears)
4. Or check **Permissions** tab for that object

### Step 5: Test the URL

After making changes, test a direct URL in your browser:
```
https://nealy-decor-bucket.s3.us-east-2.amazonaws.com/01-Website-Creation/03%20Gallery/BlueSofaLounge/IMG_0936.jpg
```

If it loads in the browser, permissions are correct.

### Step 6: Set Production Environment Variables

If deploying to Vercel/Netlify/etc., add these environment variables:

```
NEXT_PUBLIC_S3_BUCKET_NAME=nealy-decor-bucket
NEXT_PUBLIC_S3_REGION=us-east-2
```

**For Vercel:**
1. Go to your project → Settings → Environment Variables
2. Add both variables
3. Redeploy

**For Netlify:**
1. Go to Site settings → Environment variables
2. Add both variables
3. Redeploy

## Common Issues

### Issue: "Block public access" won't turn off
- You may need to wait a few minutes for AWS to propagate changes
- Try refreshing the page
- Check if you have the correct IAM permissions

### Issue: Bucket policy shows "Invalid JSON"
- Make sure there are no trailing commas
- Validate JSON syntax using a JSON validator
- Copy the exact policy from this document

### Issue: Still getting 403 after all steps
- Wait 5-10 minutes for AWS to propagate changes
- Clear your browser cache
- Try accessing the URL in an incognito window
- Check CloudWatch logs if using CloudFront

## Verification

Run the test script:
```bash
node scripts/test-s3-url.js
```

If it returns `200 OK`, your S3 is correctly configured!

